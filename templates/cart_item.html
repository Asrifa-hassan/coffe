{% include 'header.html' %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/swiper-bundle.min.css' %}">
<style>
/* --- your CSS kept as is (shortened for clarity) --- */
.cart{background:#fff;padding:4vh 5vh;border-bottom-left-radius:1rem;border-top-left-radius:1rem;}
.summary{background:#ddd;border-top-right-radius:1rem;border-bottom-right-radius:1rem;padding:4vh;color:#414141;}
.quantity-control{display:flex;align-items:center;}
.quantity-control button{width:28px;height:28px;border:1px solid #aaa;background:#f8f8f8;cursor:pointer;}
.quantity-control .quantity{font-size:15px;width:30px;text-align:center;}
.read_bt a{font-size:12px;background:#ff050a;color:#fff;padding:10px;border-radius:5px;text-transform:uppercase;}
</style>

<body>
<div class="coffee_section">
  <div class="container" style="padding-top:10px;">
    <div class="card">
      {% if cart_data %}
      <div class="row">
        <!-- Cart Section -->
        <div class="col-md-8 cart">
          <div class="title">
            <div class="row">
              <div class="col"><h4><b>Shopping Cart</b></h4></div>
            </div>
          </div>

          <div class="row border-top border-bottom" id="cart">
            {% for i in cart_data %}
            <div class="row main align-items-center cart-item" data-item-id="{{ i.id }}">
              <div class="col-2">
                <img class="img-fluid" src="{{ i.item.image.url }}">
              </div>
              <div class="col">
                <div class="row text-muted">{{ i.item.item_name }}</div>
              </div>
              <div class="quantity-control">
                <button type="button" class="decrement">-</button>
                <span class="quantity">{{ i.quantity }}</span>
                <button type="button" class="increment">+</button>
              </div>
              <div class="col item-total">₹ {{ i.item_total }}</div>
              <span>
                <!-- ✅ FIX: use cart id, not item_id -->
                <a href="{% url 'delete_cart_item' i.id %}" style="color:black;">
                  <i class="fa fa-times" style="font-size:12px;"></i>
                </a>
              </span>
            </div>
            {% endfor %}
          </div>

          <div class="back-to-shop">
            <a href="{% url 'coffees' %}">&leftarrow;</a>
            <span class="text-muted">Back to shop</span>
          </div>
        </div>

        <!-- Summary Section -->
        <div class="col-md-4 summary">
          <div><h5><b>Summary</b></h5></div>
          <hr>
          {% for i in cart_data %}
          <div class="row summary-item" data-item-id="{{ i.id }}">
            <div class="col" style="padding-left:0;">{{ i.item.item_name }} ({{ i.quantity }})</div>
            <div class="col text-right">₹ {{ i.item_total }}</div>
          </div>
          {% endfor %}
          <hr>
          <div class="row">
            <div class="text-right"><strong>Grand Total: <span id="grand-total">₹ {{ grand_total }}</span></strong></div>
          </div>

          <!-- Address Section -->
          <div class="address-section mt-3">
            <h5 style="font-size:15px;"><b>Delivery Address</b></h5>
            {% if address %}
            <form action="{% url 'order_items' %}" method="POST">
              {% csrf_token %}
              <label for="address">Select Address:</label>
              <select id="address" name="address" class="form-control">
                {% for i in address %}
                  <option value="{{ i.id }}">{{ i.city }}, {{ i.Zipcode }}, {{ i.Land_Mark }}</option>
                {% endfor %}
              </select>
              <button type="submit" class="btn btn-round btn-danger mt-2" style="height:37px;width:35%;">Checkout</button>
            </form>
            {% else %}
            <div class="buttons">
              <a href="{% url 'add_address'%}" class="btn btn-danger mt-2" style="height:35px;width:61%;font-size:14px;text-align:center;">Add Address</a>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      {% else %}
      <!-- Empty Cart -->
      <div class="row">
        <div class="col-md-12">
          <div class="card-body cart">
            <div class="col-sm-12 empty-cart-cls text-center">
              <img src="{% static 'images/11329060.png' %}" width="130" height="130" class="img-fluid mb-4 mr-3">
              <h3><strong>Your Cart is Empty</strong></h3>
              <h4>Add something to make me happy :)</h4>
              <div class="read_bt"><a href="{% url 'coffees' %}">Continue shopping</a></div>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Footer -->
<div class="footer_section layout_padding"> ... (keep your footer as is) ... </div>
<div class="copyright_section"> ... </div>

<script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
<script>
function getCSRFToken(){
  let cookieValue=null;const name="csrftoken";
  if(document.cookie&&document.cookie!==""){
    const cookies=document.cookie.split(";");
    for(let cookie of cookies){
      cookie=cookie.trim();
      if(cookie.startsWith(name+"=")){
        cookieValue=decodeURIComponent(cookie.substring(name.length+1));break;
      }
    }
  }
  return cookieValue;
}

document.addEventListener("DOMContentLoaded",()=>{
  document.querySelectorAll(".increment,.decrement").forEach(button=>{
    button.addEventListener("click",e=>{
      e.preventDefault();
      const row=button.closest(".cart-item");
      const itemId=row.dataset.itemId;
      const action=button.classList.contains("increment")?"increment":"decrement";

      fetch(`/cart/${action}_quantity/${itemId}/`,{
        method:"POST",
        headers:{"X-CSRFToken":getCSRFToken(),"Content-Type":"application/json"}
      })
      .then(res=>res.json())
      .then(data=>{
        if(data.removed){
          row.remove();
          document.querySelector(`.summary-item[data-item-id="${itemId}"]`)?.remove();
          if(!document.querySelector(".cart-item")){
            document.querySelector(".cart").innerHTML=`
              <div class="col-sm-12 empty-cart-cls text-center">
                <img src="/static/images/11329060.png" width="130" height="130" class="img-fluid mb-4 mr-3">
                <h3><strong>Your Cart is Empty</strong></h3>
                <h4>Add something to make me happy :)</h4>
                <div class="read_bt"><a href="/coffees">Continue shopping</a></div>
              </div>`;
            document.querySelector(".summary")?.remove();
          }
        } else {
          row.querySelector(".quantity").textContent=data.quantity;
          row.querySelector(".item-total").textContent="₹ "+data.item_total.toFixed(2);
          const summaryRow=document.querySelector(`.summary-item[data-item-id="${itemId}"]`);
          if(summaryRow){
            summaryRow.querySelector(".col").textContent=
              `${row.querySelector(".text-muted").textContent} (${data.quantity})`;
            summaryRow.querySelector(".text-right").textContent="₹ "+data.item_total.toFixed(2);
          }
        }
        document.getElementById("grand-total").textContent="₹ "+data.grand_total.toFixed(2);
      });
    });
  });
});
</script>
{% endblock %}
